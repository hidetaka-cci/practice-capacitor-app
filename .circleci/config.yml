version: 2.1

orbs:
  node: circleci/node@7.2.0

workflows:
  build:
    jobs:
      - build-web
      - build-android:
          requires:
            - build-web
      - build-ios:
          requires:
            - build-web

jobs:
  build-web:
    docker:
      - image: cimg/node:24.0
    steps:
      - checkout
      - restore_cache:
          keys:
            - node-modules-v1-{{ checksum "package-lock.json" }}
            - node-modules-v1-
      - run:
          name: npm install
          command: npm ci
      - save_cache:
          key: node-modules-v1-{{ checksum "package-lock.json" }}
          paths:
            - node_modules
      - run:
          name: Build web assets
          command: npm run build
      - persist_to_workspace:
          root: .
          paths:
            - dist
            - node_modules
            - package.json
            - package-lock.json
            - capacitor.config.json
      - store_artifacts:
          path: dist
          destination: web-build

  build-android:
    docker:
      - image: cimg/android:2026.02.1-node
    steps:
      - checkout
      - attach_workspace:
          at: .
      - node/install:
          node-version: "24.0.0"
      - restore_cache:
          keys:
            - gradle-v1-{{ checksum "android/build.gradle" }}-{{ checksum "android/app/build.gradle" }}
            - gradle-v1-
      - run:
          name: Sync Capacitor
          command: npx cap sync android
      - run:
          name: Build Android APK
          command: |
            cd android
            ./gradlew assembleDebug
      - save_cache:
          key: gradle-v1-{{ checksum "android/build.gradle" }}-{{ checksum "android/app/build.gradle" }}
          paths:
            - ~/.gradle/caches
            - ~/.gradle/wrapper
      - store_artifacts:
          path: android/app/build/outputs/apk
          destination: android-apk

  build-ios:
    macos:
      xcode: "15.4.0"
    steps:
      - checkout
      - attach_workspace:
          at: .
      - node/install:
          node-version: "24.0"
      - run:
          name: Install dependencies
          command: npm ci
      - run:
          name: Sync Capacitor
          command: npx cap sync ios
      - run:
          name: Resolve Swift Package Dependencies
          command: |
            cd ios/App
            xcodebuild -resolvePackageDependencies \
              -project App.xcodeproj \
              -scheme App \
              -derivedDataPath build/DerivedData
      - run:
          name: Clean iOS build
          command: |
            cd ios/App
            xcodebuild clean \
              -project App.xcodeproj \
              -scheme App \
              -derivedDataPath build/DerivedData || true
            rm -rf build/DerivedData || true
      - run:
          name: Build iOS
          command: |
            cd ios/App
            xcodebuild -project App.xcodeproj \
              -scheme App \
              -configuration Debug \
              -sdk iphonesimulator \
              -destination "platform=iOS Simulator,id=$(python3 - <<'PY'
import json, subprocess, sys
out = subprocess.check_output(["xcrun","simctl","list","devices","available","-j"], text=True)
data = json.loads(out)
devices = []
for runtime, ds in data.get("devices", {}).items():
  for d in ds:
    if d.get("isAvailable") and d.get("state") in ("Shutdown","Booted"):
      devices.append(d)
# Prefer iPhone, then any available simulator
for preferred in (lambda d: "iPhone" in d.get("name",""), lambda d: True):
  for d in devices:
    if preferred(d) and d.get("udid"):
      print(d["udid"])
      sys.exit(0)
sys.exit(1)
PY
)" \
              -derivedDataPath build/DerivedData \
              clean build \
              CODE_SIGN_IDENTITY="" \
              CODE_SIGNING_REQUIRED=NO \
              CODE_SIGNING_ALLOWED=NO \
              2>&1 | tee build.log
      - store_artifacts:
          path: ios/App/build
          destination: ios-build
      - store_artifacts:
          path: ios/App/build.log
          destination: ios-build-log