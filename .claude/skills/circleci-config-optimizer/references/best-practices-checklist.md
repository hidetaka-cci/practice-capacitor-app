# CircleCI ベストプラクティス チェックリスト

## 基本設定

- [ ] CircleCI 2.1 を使用
- [ ] version: 2.1 が明記されている
- [ ] jobs と workflows が適切に定義されている

## リソース最適化

- [ ] 全ジョブに resource_class が明示的に指定されている
- [ ] 短時間ジョブ (<5分) で large/xlarge を使用していない
- [ ] CPU集約的ジョブに適切なリソースが割り当てられている
- [ ] メモリ集約的ジョブに十分なRAMが確保されている

## キャッシュ戦略

- [ ] 依存関係インストールに restore_cache を使用
- [ ] キャッシュキーにロックファイルのチェックサムを含む
- [ ] フォールバックキーを設定 (部分一致用)
- [ ] save_cache でキャッシュを保存
- [ ] 適切なパスのみキャッシュ (不要なファイル除外)
- [ ] キャッシュにバージョンプレフィックス (v1- 等)

## 並列化

- [ ] テストジョブで parallelism を検討
- [ ] circleci tests split を使用
- [ ] store_test_results でテスト結果を保存
- [ ] timing-based splitting を使用 (履歴がある場合)
- [ ] ワークフロー内の独立ジョブが並列実行されている

## Docker最適化

- [ ] Dockerビルドで setup_remote_docker を使用
- [ ] Docker Layer Caching (dlc: true) を有効化
- [ ] 適切なベースイメージを選択 (cimg/* 推奨)
- [ ] マルチステージビルドを活用 (該当する場合)

## Orbs活用

- [ ] 共通タスクに公式Orbsを使用
- [ ] AWS操作に aws-cli Orb を検討
- [ ] Slack通知に slack Orb を検討
- [ ] Node.jsプロジェクトに node Orb を検討

## ワークフロー設計

- [ ] 依存関係が明確 (requires を適切に使用)
- [ ] 本番デプロイ前に承認ステップ (type: approval)
- [ ] ブランチフィルターで不要な実行を防止
- [ ] タグフィルターでリリース処理を制御
- [ ] クリティカルパスを最小化

## セキュリティ

- [ ] APIキーやトークンをハードコードしていない
- [ ] 環境変数を使用 ($ENV_VAR)
- [ ] Contexts で機密情報を管理
- [ ] 最小権限の原則を適用
- [ ] 認証情報のローテーション計画

## エラーハンドリング

- [ ] when: on_fail でクリーンアップ処理
- [ ] エラー時の通知設定
- [ ] ログの適切な出力
- [ ] タイムアウトの設定
- [ ] リトライロジック (必要に応じて)

## 可観測性

- [ ] store_test_results でテスト結果を保存
- [ ] store_artifacts で成果物を保存
- [ ] 適切なログレベル
- [ ] メトリクス収集 (該当する場合)

## 保守性

- [ ] Orbs や再利用可能なコマンドで DRY
- [ ] 明確なジョブ名
- [ ] コメントで複雑な処理を説明
- [ ] 環境変数で設定を外部化
- [ ] バージョン管理 (Orbs, Docker images)

## パフォーマンス

- [ ] 不要なステップを削除
- [ ] ジョブの実行順序を最適化
- [ ] checkout の重複を避ける (workspaces 活用)
- [ ] 大きなファイルの転送を最小化
- [ ] 条件付き実行で不要な処理をスキップ

## チーム協業

- [ ] 設定ファイルが分かりやすい
- [ ] ドキュメント化 (コメント or 別ドキュメント)
- [ ] 変更履歴の記録
- [ ] レビュープロセスの確立
- [ ] Insights の定期的な確認

## コスト管理

- [ ] 定期的にコストを確認
- [ ] 不要な実行を削減 (フィルター活用)
- [ ] resource_class の最適化
- [ ] 並列化の費用対効果を評価
- [ ] キャッシュでビルド時間短縮

## 環境別設定

### 開発環境
- [ ] 軽量なテストセットで高速フィードバック
- [ ] デプロイステップをスキップ

### ステージング環境
- [ ] 完全なテストスイート実行
- [ ] 自動デプロイ

### 本番環境
- [ ] 承認ステップ必須
- [ ] 完全なテストとセキュリティチェック
- [ ] ロールバック計画

## 定期メンテナンス

- [ ] 月次: コストレビュー
- [ ] 月次: 実行時間の推移確認
- [ ] 四半期: 依存関係の更新
- [ ] 四半期: Orbs のバージョン更新
- [ ] 四半期: 設定の全体見直し

## アンチパターン (避けるべき)

- [ ] ❌ ハードコードされた機密情報
- [ ] ❌ キャッシュなしの依存関係インストール
- [ ] ❌ 全てのジョブが直列実行
- [ ] ❌ resource_class の過剰使用
- [ ] ❌ テスト結果の保存なし
- [ ] ❌ 意味のないジョブ名 (job1, job2等)
- [ ] ❌ 巨大な単一ジョブ (分割推奨)
- [ ] ❌ エラーハンドリングなし
- [ ] ❌ 古いCircleCI 2.0形式
- [ ] ❌ 承認なしの本番デプロイ

## チェック頻度

### 毎ビルド
- エラー/警告の確認
- 実行時間の監視

### 毎週
- Insights でボトルネック特定
- 失敗率の確認

### 毎月
- コストレビュー
- キャッシュヒット率確認
- 並列化効果の測定

### 四半期
- 全体設計の見直し
- 新機能の検討
- 依存関係の更新

## 改善の優先順位

1. **高優先度 (即座に対応)**
   - セキュリティリスク (ハードコード等)
   - リソースの過剰使用
   - キャッシュなしの依存関係インストール

2. **中優先度 (計画的に対応)**
   - 並列化の導入
   - ワークフロー最適化
   - Orbs への移行

3. **低優先度 (時間があれば)**
   - ジョブ名の改善
   - コメントの追加
   - 小規模なリファクタリング

## 参考リソース

- [CircleCI 公式ドキュメント](https://circleci.com/docs/)
- [Orbs Registry](https://circleci.com/developer/orbs)
- [CircleCI Blog](https://circleci.com/blog/)
- [Community Forum](https://discuss.circleci.com/)
